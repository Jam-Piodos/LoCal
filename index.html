<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1.0"/>
  <title>Land Survey - Bearing + Distance to GPS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; }
    
    #map { width:100%; flex: 1; min-height: 400px; }
    
    .panel { 
      padding: 15px; 
      background: #f7f9fb; 
      border-top: 2px solid #ddd;
      overflow-y: auto;
      max-height: 40vh;
    }
    
    .input-group { margin-bottom: 12px; }
    .input-group label { 
      display: inline-block; 
      width: 100px; 
      font-weight: bold;
      font-size: 13px;
    }
    .input-group input { 
      padding: 6px; 
      border: 1px solid #ccc;
      border-radius: 3px;
      width: 150px;
    }
    
    textarea { 
      width: 100%; 
      padding: 8px; 
      font-family: 'Courier New', monospace;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 8px;
    }
    button:hover { background: #45a049; }
    
    .btn-secondary { background: #2196F3; }
    .btn-secondary:hover { background: #0b7dda; }
    
    .results { 
      margin-top: 15px;
      padding: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .info-text { 
      color: #666; 
      font-size: 12px; 
      margin-top: 5px;
      font-style: italic;
    }
    
    h3 { margin: 10px 0; color: #333; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <h3>üìç Starting Point (GPS Coordinates)</h3>
  <div class="input-group">
    <label>Latitude:</label>
    <input id="startLat" value="8.398673" type="number" step="any">
  </div>
  <div class="input-group">
    <label>Longitude:</label>
    <input id="startLon" value="124.894305" type="number" step="any">
  </div>
  
  <h3>üìê Survey Data (Bearing & Distance)</h3>
  <p class="info-text">Format: Line, Bearing, Distance(m), Northing, Easting (one per line)<br>
  Example: 1-2, N43-02E, 96.005, 20000.000, 20000.000</p>
  
  <textarea id="traverseInput" rows="6">1-2, N43-02E, 96.005, 20000.000, 20000.000
2-3, S41-22W, 340.50, 23423.240, 23198.620
2-3, S41-22W, 329.80, 23311.940, 23013.590
4-1, N39-11E, 285.50, 22021.940, 23018.230</textarea>
  
  <div style="margin-top: 10px;">
    <button onclick="plotTraverse()">üó∫Ô∏è Plot on Map</button>
    <button class="btn-secondary" onclick="clearMap()">üóëÔ∏è Clear</button>
    <button class="btn-secondary" onclick="loadSample()">üìã Load Sample</button>
  </div>
  
  <div id="info" class="results"></div>
</div>

<script>
// Parse bearing notation like "N43-02E" or "S41-22W" to decimal degrees
function parseBearing(bearingStr) {
  bearingStr = bearingStr.trim().toUpperCase();
  
  // Handle decimal degrees directly
  if (!isNaN(bearingStr)) {
    return parseFloat(bearingStr);
  }
  
  // Parse N/S/E/W notation like N43-02E
  const match = bearingStr.match(/([NS])(\d+)-?(\d+)?([EW])?/);
  if (!match) return null;
  
  const [, ns, deg, min, ew] = match;
  let angle = parseFloat(deg);
  if (min) angle += parseFloat(min) / 60;
  
  // Convert to azimuth (0-360, clockwise from North)
  if (ns === 'N' && ew === 'E') {
    return angle;
  } else if (ns === 'S' && ew === 'E') {
    return 180 - angle;
  } else if (ns === 'S' && ew === 'W') {
    return 180 + angle;
  } else if (ns === 'N' && ew === 'W') {
    return 360 - angle;
  } else if (ns === 'N' && !ew) {
    return 0;
  } else if (ns === 'S' && !ew) {
    return 180;
  }
  
  return null;
}

// Forward geodesic calculation
function destPoint(lat1, lon1, bearing, dist) {
  const R = 6371000; // Earth radius in meters
  const brng = bearing * Math.PI / 180;
  const œÜ1 = lat1 * Math.PI / 180;
  const Œª1 = lon1 * Math.PI / 180;
  const Œ¥ = dist / R;
  
  const œÜ2 = Math.asin(
    Math.sin(œÜ1) * Math.cos(Œ¥) +
    Math.cos(œÜ1) * Math.sin(Œ¥) * Math.cos(brng)
  );
  
  const Œª2 = Œª1 + Math.atan2(
    Math.sin(brng) * Math.sin(Œ¥) * Math.cos(œÜ1),
    Math.cos(Œ¥) - Math.sin(œÜ1) * Math.sin(œÜ2)
  );
  
  return { 
    lat: œÜ2 * 180 / Math.PI, 
    lon: Œª2 * 180 / Math.PI 
  };
}

// Initialize Leaflet map
const map = L.map('map').setView([8.398673, 124.894305], 17);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri',
  maxZoom: 19
}).addTo(map);

let lotLayer = null;

function plotTraverse() {
  if (lotLayer) map.removeLayer(lotLayer);
  
  const startLat = parseFloat(document.getElementById('startLat').value);
  const startLon = parseFloat(document.getElementById('startLon').value);
  
  if (isNaN(startLat) || isNaN(startLon)) {
    alert('Please enter valid starting coordinates');
    return;
  }
  
  const inputLines = document.getElementById('traverseInput').value.trim().split("\n");
  let current = { lat: startLat, lon: startLon };
  let corners = [current];
  let infoText = `Point 1 (Start): ${startLat.toFixed(7)}, ${startLon.toFixed(7)}\n`;
  infoText += '‚îÄ'.repeat(60) + '\n';
  
  for (let i = 0; i < inputLines.length; i++) {
    const line = inputLines[i].trim();
    if (!line) continue;
    
    // Split by comma
    const parts = line.split(',').map(p => p.trim());
    if (parts.length < 3) continue;
    
    const lineName = parts[0];
    const bearingStr = parts[1];
    const distStr = parts[2];
    
    const bearing = parseBearing(bearingStr);
    const dist = parseFloat(distStr);
    
    if (bearing === null || isNaN(dist)) {
      infoText += `‚ö†Ô∏è  Line ${lineName}: Invalid format\n`;
      continue;
    }
    
    current = destPoint(current.lat, current.lon, bearing, dist);
    corners.push(current);
    
    infoText += `Point ${i + 2} (${lineName}):\n`;
    infoText += `  Bearing: ${bearingStr} ‚Üí ${bearing.toFixed(2)}¬∞\n`;
    infoText += `  Distance: ${dist.toFixed(2)}m\n`;
    infoText += `  GPS: ${current.lat.toFixed(7)}, ${current.lon.toFixed(7)}\n\n`;
  }
  
  // Calculate area (approximate)
  const area = calculateArea(corners);
  infoText += '‚îÄ'.repeat(60) + '\n';
  infoText += `Total Points: ${corners.length}\n`;
  infoText += `Approximate Area: ${area.toFixed(2)} sq.m (${(area / 10000).toFixed(4)} hectares)\n`;
  
  document.getElementById('info').innerText = infoText;
  
  // Draw polygon on map
  const polyCoords = corners.map(p => [p.lat, p.lon]);
  lotLayer = L.layerGroup().addTo(map);
  
  L.polygon(polyCoords, { 
    color: '#ff6b00', 
    weight: 3, 
    fillOpacity: 0.15,
    fillColor: '#ffaa00'
  }).addTo(lotLayer).bindPopup(`<b>Land Survey</b><br>Area: ${area.toFixed(2)} sq.m`);
  
  // Add corner markers
  corners.forEach((pt, i) => {
    L.circleMarker([pt.lat, pt.lon], {
      radius: 6, 
      color: '#fff', 
      fillColor: i === 0 ? '#4CAF50' : '#2196F3', 
      fillOpacity: 1,
      weight: 2
    }).addTo(lotLayer).bindPopup(`<b>Point ${i + 1}</b><br>${pt.lat.toFixed(7)}, ${pt.lon.toFixed(7)}`);
    
    // Add labels
    L.marker([pt.lat, pt.lon], {
      icon: L.divIcon({
        className: 'label',
        html: `<div style="background:rgba(255,255,255,0.8);padding:2px 5px;border-radius:3px;font-size:11px;font-weight:bold;">P${i + 1}</div>`,
        iconSize: [30, 20]
      })
    }).addTo(lotLayer);
  });
  
  map.fitBounds(polyCoords, { padding: [50, 50] });
}

function calculateArea(corners) {
  if (corners.length < 3) return 0;
  
  // Using spherical excess formula (approximate)
  let area = 0;
  for (let i = 0; i < corners.length; i++) {
    const j = (i + 1) % corners.length;
    const lat1 = corners[i].lat * Math.PI / 180;
    const lat2 = corners[j].lat * Math.PI / 180;
    const lon1 = corners[i].lon * Math.PI / 180;
    const lon2 = corners[j].lon * Math.PI / 180;
    
    area += (lon2 - lon1) * (2 + Math.sin(lat1) + Math.sin(lat2));
  }
  
  area = Math.abs(area * 6371000 * 6371000 / 2);
  return area;
}

function clearMap() {
  if (lotLayer) {
    map.removeLayer(lotLayer);
    lotLayer = null;
  }
  document.getElementById('info').innerText = '';
}

function loadSample() {
  document.getElementById('traverseInput').value = `1-2, N43-02E, 96.005, 20000.000, 20000.000
2-3, S41-22W, 340.50, 23423.240, 23198.620
3-4, S41-22W, 329.80, 23311.940, 23013.590
4-1, N39-11E, 285.50, 22021.940, 23018.230`;
  plotTraverse();
}

// Auto-plot on load
plotTraverse();
</script>

</body>
</html>
