<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIDAS37 Survey Traverse</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; display:flex; flex-direction:column; height:100vh; }
  #map { flex:1; }
  .panel { padding:10px; background:#f7f9fb; border-top:1px solid #ddd; max-height:45vh; overflow:auto; }
  .input-group { margin-bottom:8px; display:flex; align-items:center; }
  .input-group label { width:120px; font-weight:bold; font-size:13px; }
  .input-group input, .input-group select { padding:5px 8px; border:1px solid #ccc; border-radius:3px; font-size:13px; flex:1; }
  button { background:#4CAF50; color:white; border:none; padding:8px 12px; border-radius:3px; cursor:pointer; margin-right:5px; }
  button:hover { background:#45a049; }
  .points-list { border:1px solid #ddd; padding:8px; border-radius:4px; max-height:200px; overflow:auto; margin-top:10px; font-size:13px; }
  .point-item { display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:3px 0; }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <h3>Starting Point (Lat/Lon)</h3>
  <div class="input-group">
    <label>Latitude:</label><input id="startLat" type="number" step="any" value="8.398673">
  </div>
  <div class="input-group">
    <label>Longitude:</label><input id="startLon" type="number" step="any" value="124.894305">
  </div>
  <button onclick="saveStartPoint()">Save Start Point</button>

  <h3>Add Traverse Point</h3>
  <div class="input-group">
    <label>Line Name:</label><input id="lineName" placeholder="1-2">
  </div>
  <div class="input-group">
    <label>Bearing (°):</label><input id="bearing" type="number" placeholder="0-360">
  </div>
  <div class="input-group">
    <label>Distance (m):</label><input id="distance" type="number" placeholder="Optional for first point">
  </div>
  <button onclick="addPoint()">Add Point</button>
  <button onclick="plotTraverse()">Update Map</button>
  <button onclick="clearAll()">Clear All</button>

  <h3>Points List (<span id="pointCount">0</span>)</h3>
  <div class="points-list" id="pointsList">No points added yet.</div>
</div>

<script>
// --- VIDAS37 parameters for Manolo Fortich (similar to UTM Zone 51N) ---
const R = 6378137; // WGS84
const originLat = 0; // Equator
const originLon = 125; // Central meridian near Bukidnon/VIDAS37
const k0 = 0.9996;
const falseEasting = 500000;
const falseNorthing = 0;

function latLonToVIDAS37(lat, lon) {
  const φ = lat * Math.PI/180;
  const λ = lon * Math.PI/180;
  const λ0 = originLon * Math.PI/180;

  const N = R / Math.sqrt(1 - 0.00669438 * Math.sin(φ)**2);
  const T = Math.tan(φ)**2;
  const C = 0.00673949675 * Math.cos(φ)**2;
  const A = (λ - λ0) * Math.cos(φ);

  const M = R*((1-0.00669438/4-3*0.00669438**2/64-5*0.00669438**3/256)*φ
    - (3*0.00669438/8+3*0.00669438**2/32+45*0.00669438**3/1024)*Math.sin(2*φ)
    + (15*0.00669438**2/256+45*0.00669438**3/1024)*Math.sin(4*φ)
    - (35*0.00669438**3/3072)*Math.sin(6*φ));

  const x = falseEasting + k0*N*(A + (1-T+C)*A**3/6 + (5-18*T+T**2+72*C-58*0.00673949675)*A**5/120);
  const y = falseNorthing + k0*(M + N*Math.tan(φ)*(A**2/2 + (5-T+9*C+4*C**2)*A**4/24 + (61-58*T+T**2+600*C-330*0.00673949675)*A**6/720));
  return {E:x, N:y};
}

function vidas37ToLatLon(E, N) {
  const M0 = 0;
  const M = (N - falseNorthing)/k0 + M0;
  const μ = M / (R*(1 - 0.00669438/4 - 3*0.00669438**2/64 - 5*0.00669438**3/256));
  // Approximate φ1 using series expansion
  let φ1 = μ + (3*0.00669438/2 - 27*0.00669438**3/32)*Math.sin(2*μ)
                  + (21*0.00669438**2/16 - 55*0.00669438**3/32)*Math.sin(4*μ)
                  + (151*0.00669438**3/96)*Math.sin(6*μ);

  const C1 = 0.00673949675 * Math.cos(φ1)**2;
  const T1 = Math.tan(φ1)**2;
  const N1 = R / Math.sqrt(1 - 0.00669438 * Math.sin(φ1)**2);
  const R1 = N1 * (1 - 0.00669438) / (1 - 0.00669438 * Math.sin(φ1)**2);
  const D = (E - falseEasting)/(N1*k0);

  const lat = φ1 - (N1*Math.tan(φ1)/R1)*(D**2/2 - (5+3*T1+10*C1-4*C1**2-9*0.00673949675)*D**4/24 + (61+90*T1+298*C1+45*T1**2-252*0.00673949675-3*C1**2)*D**6/720);
  const lon = originLon*Math.PI/180 + (D - (1+2*T1+C1)*D**3/6 + (5-2*C1+28*T1-3*C1**2+8*0.00673949675+24*T1**2)*D**5/120)/Math.cos(φ1);
  return {lat: lat*180/Math.PI, lon: lon*180/Math.PI};
}

// --- Survey logic ---
let surveyPoints = [];
let startPoint = null;

function saveStartPoint() {
  const lat = parseFloat(document.getElementById('startLat').value);
  const lon = parseFloat(document.getElementById('startLon').value);
  if(isNaN(lat) || isNaN(lon)){ alert("Enter valid start point."); return; }
  startPoint = latLonToVIDAS37(lat, lon);
  alert("Start point saved in VIDAS37 meters.");
}

function addPoint() {
  if(!startPoint){ alert("Save start point first."); return; }
  const lineName = document.getElementById('lineName').value.trim();
  const bearing = parseFloat(document.getElementById('bearing').value);
  let distance = parseFloat(document.getElementById('distance').value);
  
  if(isNaN(bearing)){ alert("Enter valid bearing."); return; }
  if(surveyPoints.length === 0){ distance = distance || 0; } // first point can have zero distance
  else if(isNaN(distance)){ alert("Enter distance for subsequent points."); return; }

  surveyPoints.push({lineName, bearing, distance});
  updatePointsList();
}

function updatePointsList(){
  const list = document.getElementById('pointsList');
  document.getElementById('pointCount').innerText = surveyPoints.length;
  if(surveyPoints.length===0){ list.innerHTML="No points added yet."; return; }
  list.innerHTML = surveyPoints.map((pt,i)=>`<div class="point-item">P${i+2} - ${pt.lineName}: ${pt.bearing}° / ${pt.distance}m</div>`).join('');
}

function plotTraverse(){
  if(!startPoint){ alert("Save start point first."); return; }
  if(lotLayer) map.removeLayer(lotLayer);

  let current = {...startPoint};
  const corners = [current];

  for(let pt of surveyPoints){
    const rad = pt.bearing * Math.PI/180;
    current = {E: current.E + pt.distance*Math.sin(rad), N: current.N + pt.distance*Math.cos(rad)};
    corners.push({...current});
  }

  // Convert back to Lat/Lon for Leaflet
  const latlonCorners = corners.map(p => vidas37ToLatLon(p.E, p.N));

  lotLayer = L.layerGroup().addTo(map);
  L.polygon(latlonCorners, {color:'#ff6b00', fillOpacity:0.15}).addTo(lotLayer);
  latlonCorners.forEach((p,i)=>{
    L.circleMarker([p.lat,p.lon],{radius:6,color:'#2196F3',fillOpacity:1}).addTo(lotLayer)
      .bindPopup(`Point ${i+1}<br>Lat: ${p.lat.toFixed(7)}<br>Lon: ${p.lon.toFixed(7)}`);
  });

  map.fitBounds(latlonCorners.map(p=>[p.lat,p.lon]), {padding:[50,50]});
}

// Clear all
function clearAll(){ surveyPoints=[]; startPoint=null; updatePointsList(); if(lotLayer) map.removeLayer(lotLayer); }

// --- Initialize Leaflet map ---
const map = L.map('map').setView([parseFloat(document.getElementById('startLat').value), parseFloat(document.getElementById('startLon').value)],17);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19, attribution:'Tiles © Esri'}).addTo(map);

let lotLayer = null;
</script>
</body>
</html>
