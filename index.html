<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Land Survey - Bearing & Distance</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; font-family: Arial,sans-serif; display:flex; flex-direction:column; height:100vh; }
  #map { flex:1; min-height:400px; }
  .panel { padding:10px; background:#f7f9fb; border-top:2px solid #ddd; overflow-y:auto; max-height:45vh; }
  .input-section { margin-bottom:15px; }
  .input-group { margin-bottom:10px; display:flex; align-items:center; }
  .input-group label { width:120px; font-weight:bold; font-size:13px; }
  .input-group input, .input-group select { padding:6px 8px; border:1px solid #ccc; border-radius:3px; font-size:13px; flex:1; max-width:200px; }
  button { background:#4CAF50; color:white; border:none; padding:10px 18px; cursor:pointer; border-radius:4px; font-size:14px; margin-right:5px; }
  button:hover { background:#45a049; }
  .btn-secondary { background:#2196F3; }
  .btn-secondary:hover { background:#0b7dda; }
  .points-list { background:white; border:1px solid #ddd; border-radius:4px; padding:10px; max-height:250px; overflow-y:auto; }
  .point-item { padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .point-item:last-child { border-bottom:none; }
  .point-number { font-weight:bold; color:#2196F3; margin-right:10px; }
  .info-text { font-size:12px; color:#666; font-style:italic; margin-bottom:5px; }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="input-section">
    <h3>‚ûï Add Point</h3>
    <p class="info-text">First point: enter bearing only. Subsequent points: bearing + distance.</p>
    
    <div class="input-group">
      <label>Line Name:</label>
      <input id="lineName" value="1-2" placeholder="e.g., 1-2, A-B">
    </div>

    <div class="input-group">
      <label>Bearing Type:</label>
      <select id="bearingType">
        <option value="N">North (N)</option>
        <option value="E">East (E)</option>
        <option value="S">South (S)</option>
        <option value="W">West (W)</option>
      </select>
    </div>

    <div class="input-group">
      <label>Distance (m):</label>
      <input id="distance" type="number" step="any" placeholder="Distance" disabled>
    </div>

    <div>
      <button onclick="addPoint()">‚ûï Add Point</button>
      <button class="btn-secondary" onclick="plotTraverse()">üó∫Ô∏è Update Map</button>
      <button onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>
  </div>

  <h3>üìã Points List (<span id="pointCount">0</span>)</h3>
  <div class="points-list" id="pointsList">
    <div class="empty-state">No points added yet.</div>
  </div>
</div>

<script>
let surveyPoints = [];
const map = L.map('map').setView([8.398673, 124.894305], 17);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri', maxZoom: 19
}).addTo(map);

let lotLayer = null;

// Enable distance only after first point
function updateDistanceInput() {
  const distanceInput = document.getElementById('distance');
  distanceInput.disabled = surveyPoints.length === 0;
}
updateDistanceInput();

// Convert bearing to azimuth in degrees (N=0, clockwise)
function bearingToAzimuth(bearing) {
  switch(bearing) {
    case 'N': return 0;
    case 'E': return 90;
    case 'S': return 180;
    case 'W': return 270;
    default: return 0;
  }
}

// Forward geodesic (dest point from lat,lon,bearing,distance)
function destPoint(lat1, lon1, azimuth, dist) {
  const R = 6371000; // meters
  const brng = azimuth * Math.PI/180;
  const œÜ1 = lat1 * Math.PI/180;
  const Œª1 = lon1 * Math.PI/180;
  const Œ¥ = dist / R;
  const œÜ2 = Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥) + Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(brng));
  const Œª2 = Œª1 + Math.atan2(Math.sin(brng)*Math.sin(Œ¥)*Math.cos(œÜ1), Math.cos(Œ¥)-Math.sin(œÜ1)*Math.sin(œÜ2));
  return { lat: œÜ2*180/Math.PI, lon: Œª2*180/Math.PI };
}

// Add point
function addPoint() {
  const lineName = document.getElementById('lineName').value.trim();
  const bearing = document.getElementById('bearingType').value;
  const distanceInput = document.getElementById('distance');
  let distance = parseFloat(distanceInput.value);

  if(!lineName) { alert('Enter line name'); return; }

  // First point ignores distance
  if(surveyPoints.length === 0) distance = 50; // just for visualization
  else if(isNaN(distance)) { alert('Enter valid distance'); return; }

  surveyPoints.push({ lineName, bearing, azimuth: bearingToAzimuth(bearing), distance });

  updatePointsList();
  updateDistanceInput();
  distanceInput.value = '';
  plotTraverse();

  // Auto increment line name
  const match = lineName.match(/(\d+)-(\d+)/);
  if(match) {
    const next = parseInt(match[2]) + 1;
    document.getElementById('lineName').value = `${match[2]}-${next}`;
  }
}

// Update list
function updatePointsList() {
  const list = document.getElementById('pointsList');
  document.getElementById('pointCount').innerText = surveyPoints.length;
  if(surveyPoints.length===0) { list.innerHTML='<div class="empty-state">No points added yet.</div>'; return; }
  list.innerHTML = surveyPoints.map((pt,i)=>`
    <div class="point-item">
      <span class="point-number">P${i+1}</span>
      <span>${pt.lineName}: ${pt.bearing} ‚Üí ${pt.distance}m</span>
      <button onclick="removePoint(${i})">‚úï</button>
    </div>
  `).join('');
}

// Remove point
function removePoint(i) { surveyPoints.splice(i,1); updatePointsList(); updateDistanceInput(); plotTraverse(); }

// Clear all
function clearAll() { surveyPoints=[]; updatePointsList(); updateDistanceInput(); if(lotLayer) map.removeLayer(lotLayer); lotLayer=null; }

// Plot points on map
function plotTraverse() {
  if(lotLayer) map.removeLayer(lotLayer);
  if(surveyPoints.length===0) return;

  let current = { lat: 8.398673, lon: 124.894305 };
  let corners = [current];
  lotLayer = L.layerGroup().addTo(map);

  surveyPoints.forEach(pt=>{
    current = destPoint(current.lat, current.lon, pt.azimuth, pt.distance);
    corners.push(current);
  });

  const polyCoords = corners.map(p=>[p.lat,p.lon]);
  L.polygon(polyCoords, { color:'#ff6b00', weight:3, fillOpacity:0.15 }).addTo(lotLayer);

  corners.forEach((pt,i)=>{
    L.circleMarker([pt.lat,pt.lon], { radius:6, color:'#fff', fillColor:i===0?'#4CAF50':'#2196F3', fillOpacity:1, weight:2 }).addTo(lotLayer);
    L.marker([pt.lat,pt.lon], { icon:L.divIcon({ className:'label', html:`<div style="background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:3px;font-size:11px;font-weight:bold;border:1px solid #ccc;">P${i+1}</div>`, iconSize:[30,20] })}).addTo(lotLayer);
  });

  map.fitBounds(polyCoords,{padding:[50,50]});
}
</script>
</body>
</html>
