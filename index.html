<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIDAS37 Survey - Bearing Input</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; display:flex; flex-direction: column; height:100vh; }
  #map { flex:1; }
  .panel { padding:10px; background:#f7f9fb; border-top:2px solid #ddd; max-height:45vh; overflow-y:auto; }
  .input-group { margin-bottom:8px; display:flex; align-items:center; }
  .input-group label { width:120px; font-weight:bold; font-size:13px; }
  .input-group input, select { padding:5px 8px; font-size:13px; border:1px solid #ccc; border-radius:3px; }
  .bearing-input { display:flex; gap:5px; align-items:center; }
  .bearing-input input { width:60px; }
  button { margin-top:5px; padding:8px 14px; border:none; border-radius:4px; font-size:13px; cursor:pointer; }
  .btn-add { background:#4CAF50; color:white; }
  .btn-clear { background:#f44336; color:white; }
  .points-list { margin-top:10px; background:white; border:1px solid #ddd; border-radius:4px; max-height:200px; overflow-y:auto; padding:5px; font-family: monospace; font-size:12px; }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <h3>âž• Add Bearing</h3>
  <div class="input-group">
    <label>Bearing:</label>
    <div class="bearing-input">
      <select id="dirNS">
        <option value="N">N</option>
        <option value="S">S</option>
      </select>
      <input type="number" id="deg" placeholder="Deg" min="0" max="90">
      <input type="number" id="min" placeholder="Min" min="0" max="59">
      <select id="dirEW">
        <option value="E">E</option>
        <option value="W">W</option>
      </select>
    </div>
  </div>
  <div class="input-group">
    <label>Distance (m):</label>
    <input type="number" id="distance" placeholder="Optional for first point">
  </div>
  <button class="btn-add" onclick="addPoint()">Add Point</button>
  <button class="btn-clear" onclick="clearAll()">Clear All</button>

  <h3>ðŸ“‹ Points</h3>
  <div class="points-list" id="pointsList">No points added yet.</div>
</div>

<script>
// Storage
let points = [];
let lotLayer = null;

// Initialize map at central VIDAS37 coordinates in Manolo Fortich
const map = L.map('map').setView([8.398673, 124.894305], 17);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles Â© Esri', maxZoom:19
}).addTo(map);

// Convert quadrant bearing to azimuth
function quadrantToAzimuth(ns, deg, min, ew){
  let angle = parseFloat(deg) + parseFloat(min)/60;
  let az = 0;
  if(ns==='N' && ew==='E') az = angle;
  else if(ns==='S' && ew==='E') az = 180 - angle;
  else if(ns==='S' && ew==='W') az = 180 + angle;
  else if(ns==='N' && ew==='W') az = 360 - angle;
  return az;
}

// Forward geodesic calculation
function destPoint(lat1, lon1, bearing, distance){
  const R = 6371000; // meters
  const brng = bearing*Math.PI/180;
  const Ï†1 = lat1*Math.PI/180;
  const Î»1 = lon1*Math.PI/180;
  const Î´ = distance/R;
  
  const Ï†2 = Math.asin(Math.sin(Ï†1)*Math.cos(Î´) + Math.cos(Ï†1)*Math.sin(Î´)*Math.cos(brng));
  const Î»2 = Î»1 + Math.atan2(Math.sin(brng)*Math.sin(Î´)*Math.cos(Ï†1), Math.cos(Î´)-Math.sin(Ï†1)*Math.sin(Ï†2));
  
  return { lat: Ï†2*180/Math.PI, lon: Î»2*180/Math.PI };
}

// Add point
function addPoint(){
  const ns = document.getElementById('dirNS').value;
  const ew = document.getElementById('dirEW').value;
  const deg = document.getElementById('deg').value;
  const min = document.getElementById('min').value || 0;
  const dist = parseFloat(document.getElementById('distance').value) || 0;
  
  if(deg==='') { alert('Enter degrees'); return; }
  
  const az = quadrantToAzimuth(ns, deg, min, ew);
  const bearingStr = `${ns}${deg}Â°${min}'${ew}`;
  
  points.push({bearing: az, bearingStr: bearingStr, distance: dist});
  updateList();
  plotPoints();
}

// Update list
function updateList(){
  const list = document.getElementById('pointsList');
  if(points.length===0){ list.innerHTML='No points added yet.'; return; }
  list.innerHTML = points.map((p,i)=>`${i+1}: ${p.bearingStr} | ${p.distance} m`).join('<br>');
}

// Clear all
function clearAll(){
  points = [];
  updateList();
  if(lotLayer){ map.removeLayer(lotLayer); lotLayer=null; }
}

// Plot points on map
function plotPoints(){
  if(lotLayer) map.removeLayer(lotLayer);
  if(points.length===0) return;

  lotLayer = L.layerGroup().addTo(map);
  let current = {lat:8.398673, lon:124.894305}; // origin
  let coords = [current];

  points.forEach((p,i)=>{
    let next = p.distance>0 ? destPoint(current.lat, current.lon, p.bearing, p.distance) : current;
    coords.push(next);
    current = next;
    
    L.circleMarker([current.lat, current.lon], {radius:6, color:'#2196F3', fillColor:'#2196F3', fillOpacity:1})
      .addTo(lotLayer)
      .bindPopup(`<b>Point ${i+1}</b><br>${p.bearingStr}<br>${p.distance} m`);
  });

  // Draw polygon if more than 2 points
  if(coords.length>2){
    L.polygon(coords, {color:'#ff6b00', weight:2, fillOpacity:0.15, fillColor:'#ffaa00'}).addTo(lotLayer);
    map.fitBounds(coords);
  } else {
    map.setView([current.lat, current.lon],17);
  }
}
</script>

</body>
</html>
