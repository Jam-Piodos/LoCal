<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1.0"/>
  <title>Land Survey - Point by Point Entry</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; }
    
    #map { width:100%; flex: 1; min-height: 400px; }
    
    .panel { 
      padding: 15px; 
      background: #f7f9fb; 
      border-top: 2px solid #ddd;
      overflow-y: auto;
      max-height: 45vh;
    }
    
    .input-section {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
    }
    
    .input-group { 
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    .input-group label { 
      display: inline-block; 
      width: 120px; 
      font-weight: bold;
      font-size: 13px;
    }
    .input-group input { 
      padding: 6px 8px; 
      border: 1px solid #ccc;
      border-radius: 3px;
      flex: 1;
      max-width: 200px;
    }
    
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 10px 18px; 
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 8px;
      margin-top: 5px;
    }
    button:hover { background: #45a049; }
    
    .btn-secondary { background: #2196F3; }
    .btn-secondary:hover { background: #0b7dda; }
    
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #da190b; }
    
    .btn-small { padding: 5px 10px; font-size: 12px; }
    
    .points-list {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .point-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    
    .point-item:last-child { border-bottom: none; }
    .point-item:hover { background: #f5f5f5; }
    
    .point-info {
      font-family: 'Courier New', monospace;
      flex: 1;
    }
    
    .point-number {
      font-weight: bold;
      color: #2196F3;
      margin-right: 10px;
    }
    
    .results { 
      margin-top: 15px;
      padding: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .info-text { 
      color: #666; 
      font-size: 12px; 
      margin-top: 5px;
      font-style: italic;
    }
    
    h3 { margin: 10px 0 8px 0; color: #333; font-size: 16px; }
    
    .empty-state {
      text-align: center;
      color: #999;
      padding: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="input-section">
    <h3>üìç Starting Point (Required)</h3>
    <div class="input-group">
      <label>Latitude:</label>
      <input id="startLat" value="8.398673" type="number" step="any">
    </div>
    <div class="input-group">
      <label>Longitude:</label>
      <input id="startLon" value="124.894305" type="number" step="any">
    </div>
  </div>
  
  <div class="input-section">
    <h3>‚ûï Add Point</h3>
    <p class="info-text">Add points one by one using bearing and distance from previous point</p>
    
    <div class="input-group">
      <label>Line Name:</label>
      <input id="lineName" value="1-2" placeholder="e.g., 1-2, A-B">
    </div>
    
    <div class="input-group">
      <label>Bearing:</label>
      <input id="bearing" placeholder="e.g., N43-02E or 43.5">
    </div>
    
    <div class="input-group">
      <label>Distance (m):</label>
      <input id="distance" type="number" step="any" placeholder="e.g., 96.005">
    </div>
    
    <div>
      <button onclick="addPoint()">‚ûï Add Point</button>
      <button class="btn-secondary" onclick="plotTraverse()">üó∫Ô∏è Update Map</button>
      <button class="btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>
  </div>
  
  <h3>üìã Points List (<span id="pointCount">0</span>)</h3>
  <div class="points-list" id="pointsList">
    <div class="empty-state">No points added yet. Add your first point above.</div>
  </div>
  
  <div id="info" class="results" style="display:none;"></div>
</div>

<script>
// Storage for points
let surveyPoints = [];

// Parse bearing notation
function parseBearing(bearingStr) {
  bearingStr = bearingStr.trim().toUpperCase();
  
  if (!isNaN(bearingStr)) {
    return parseFloat(bearingStr);
  }
  
  const match = bearingStr.match(/([NS])(\d+)-?(\d+)?([EW])?/);
  if (!match) return null;
  
  const [, ns, deg, min, ew] = match;
  let angle = parseFloat(deg);
  if (min) angle += parseFloat(min) / 60;
  
  if (ns === 'N' && ew === 'E') {
    return angle;
  } else if (ns === 'S' && ew === 'E') {
    return 180 - angle;
  } else if (ns === 'S' && ew === 'W') {
    return 180 + angle;
  } else if (ns === 'N' && ew === 'W') {
    return 360 - angle;
  } else if (ns === 'N' && !ew) {
    return 0;
  } else if (ns === 'S' && !ew) {
    return 180;
  } else if (ns === 'E' && !ns) {
    return 90;
  } else if (ns === 'W' && !ns) {
    return 270;
  }
  
  return null;
}

// Forward geodesic calculation
function destPoint(lat1, lon1, bearing, dist) {
  const R = 6371000;
  const brng = bearing * Math.PI / 180;
  const œÜ1 = lat1 * Math.PI / 180;
  const Œª1 = lon1 * Math.PI / 180;
  const Œ¥ = dist / R;
  
  const œÜ2 = Math.asin(
    Math.sin(œÜ1) * Math.cos(Œ¥) +
    Math.cos(œÜ1) * Math.sin(Œ¥) * Math.cos(brng)
  );
  
  const Œª2 = Œª1 + Math.atan2(
    Math.sin(brng) * Math.sin(Œ¥) * Math.cos(œÜ1),
    Math.cos(Œ¥) - Math.sin(œÜ1) * Math.sin(œÜ2)
  );
  
  return { 
    lat: œÜ2 * 180 / Math.PI, 
    lon: Œª2 * 180 / Math.PI 
  };
}

// Add point to list
function addPoint() {
  const lineName = document.getElementById('lineName').value.trim();
  const bearingStr = document.getElementById('bearing').value.trim();
  const distStr = document.getElementById('distance').value.trim();
  
  if (!lineName || !bearingStr || !distStr) {
    alert('Please fill in all fields');
    return;
  }
  
  const bearing = parseBearing(bearingStr);
  const distance = parseFloat(distStr);
  
  if (bearing === null) {
    alert('Invalid bearing format. Use formats like: N43-02E, S41W, or 45.5');
    return;
  }
  
  if (isNaN(distance)) {
    alert('Invalid distance value');
    return;
  }
  
  surveyPoints.push({
    lineName: lineName,
    bearingStr: bearingStr,
    bearing: bearing,
    distance: distance
  });
  
  updatePointsList();
  
  // Auto increment line name
  const match = lineName.match(/(\d+)-(\d+)/);
  if (match) {
    const next = parseInt(match[2]) + 1;
    document.getElementById('lineName').value = `${match[2]}-${next}`;
  }
  
  document.getElementById('bearing').value = '';
  document.getElementById('distance').value = '';
  document.getElementById('bearing').focus();
  
  plotTraverse();
}

// Update points list display
function updatePointsList() {
  const list = document.getElementById('pointsList');
  document.getElementById('pointCount').innerText = surveyPoints.length;
  
  if (surveyPoints.length === 0) {
    list.innerHTML = '<div class="empty-state">No points added yet. Add your first point above.</div>';
    return;
  }
  
  list.innerHTML = surveyPoints.map((pt, i) => `
    <div class="point-item">
      <span class="point-number">P${i + 2}</span>
      <span class="point-info">${pt.lineName}: ${pt.bearingStr} (${pt.bearing.toFixed(2)}¬∞), ${pt.distance}m</span>
      <button class="btn-danger btn-small" onclick="removePoint(${i})">‚úï</button>
    </div>
  `).join('');
}

// Remove point
function removePoint(index) {
  surveyPoints.splice(index, 1);
  updatePointsList();
  plotTraverse();
}

// Clear all
function clearAll() {
  if (surveyPoints.length > 0 && !confirm('Clear all points?')) {
    return;
  }
  surveyPoints = [];
  updatePointsList();
  clearMap();
  document.getElementById('info').style.display = 'none';
}

// Initialize map
const map = L.map('map').setView([8.398673, 124.894305], 17);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri',
  maxZoom: 19
}).addTo(map);

let lotLayer = null;

function plotTraverse() {
  if (lotLayer) map.removeLayer(lotLayer);
  
  const startLat = parseFloat(document.getElementById('startLat').value);
  const startLon = parseFloat(document.getElementById('startLon').value);
  
  if (isNaN(startLat) || isNaN(startLon)) {
    alert('Please enter valid starting coordinates');
    return;
  }
  
  if (surveyPoints.length === 0) {
    document.getElementById('info').style.display = 'none';
    return;
  }
  
  let current = { lat: startLat, lon: startLon };
  let corners = [current];
  let infoText = `Point 1 (Start): ${startLat.toFixed(7)}, ${startLon.toFixed(7)}\n`;
  infoText += '‚îÄ'.repeat(60) + '\n';
  
  surveyPoints.forEach((pt, i) => {
    current = destPoint(current.lat, current.lon, pt.bearing, pt.distance);
    corners.push(current);
    
    infoText += `Point ${i + 2} (${pt.lineName}):\n`;
    infoText += `  Bearing: ${pt.bearingStr} ‚Üí ${pt.bearing.toFixed(2)}¬∞\n`;
    infoText += `  Distance: ${pt.distance.toFixed(2)}m\n`;
    infoText += `  GPS: ${current.lat.toFixed(7)}, ${current.lon.toFixed(7)}\n\n`;
  });
  
  const area = calculateArea(corners);
  infoText += '‚îÄ'.repeat(60) + '\n';
  infoText += `Total Points: ${corners.length}\n`;
  infoText += `Approximate Area: ${area.toFixed(2)} sq.m (${(area / 10000).toFixed(4)} hectares)\n`;
  
  document.getElementById('info').innerText = infoText;
  document.getElementById('info').style.display = 'block';
  
  const polyCoords = corners.map(p => [p.lat, p.lon]);
  lotLayer = L.layerGroup().addTo(map);
  
  L.polygon(polyCoords, { 
    color: '#ff6b00', 
    weight: 3, 
    fillOpacity: 0.15,
    fillColor: '#ffaa00'
  }).addTo(lotLayer).bindPopup(`<b>Land Survey</b><br>Area: ${area.toFixed(2)} sq.m`);
  
  corners.forEach((pt, i) => {
    L.circleMarker([pt.lat, pt.lon], {
      radius: 6, 
      color: '#fff', 
      fillColor: i === 0 ? '#4CAF50' : '#2196F3', 
      fillOpacity: 1,
      weight: 2
    }).addTo(lotLayer).bindPopup(`<b>Point ${i + 1}</b><br>${pt.lat.toFixed(7)}, ${pt.lon.toFixed(7)}`);
    
    L.marker([pt.lat, pt.lon], {
      icon: L.divIcon({
        className: 'label',
        html: `<div style="background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:3px;font-size:11px;font-weight:bold;border:1px solid #ccc;">P${i + 1}</div>`,
        iconSize: [30, 20]
      })
    }).addTo(lotLayer);
  });
  
  map.fitBounds(polyCoords, { padding: [50, 50] });
}

function calculateArea(corners) {
  if (corners.length < 3) return 0;
  
  let area = 0;
  for (let i = 0; i < corners.length; i++) {
    const j = (i + 1) % corners.length;
    const lat1 = corners[i].lat * Math.PI / 180;
    const lat2 = corners[j].lat * Math.PI / 180;
    const lon1 = corners[i].lon * Math.PI / 180;
    const lon2 = corners[j].lon * Math.PI / 180;
    
    area += (lon2 - lon1) * (2 + Math.sin(lat1) + Math.sin(lat2));
  }
  
  area = Math.abs(area * 6371000 * 6371000 / 2);
  return area;
}

function clearMap() {
  if (lotLayer) {
    map.removeLayer(lotLayer);
    lotLayer = null;
  }
}

// Enter key support
document.getElementById('distance').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    addPoint();
  }
});
</script>

</body>
</html>
